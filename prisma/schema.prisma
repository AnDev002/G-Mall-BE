generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // C√≥ th·ªÉ ƒë·ªïi th√†nh "postgresql" n·∫øu mu·ªën d√πng JSONB m·∫°nh m·∫Ω h∆°n
  url      = env("DATABASE_URL")
}

// --------------------------------------
// ENUMS
// --------------------------------------

enum Role {
  BUYER
  SELLER
  PENDING_SELLER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPING
  DELIVERED
  CANCELLED
}

// --------------------------------------
// MODELS
// --------------------------------------

enum FriendshipStatus {
  PENDING   // ƒêang ch·ªù ch·∫•p nh·∫≠n
  ACCEPTED  // ƒê√£ l√† b·∫°n b√®
  BLOCKED   // ƒê√£ ch·∫∑n
}

model Friendship {
  id          String           @id @default(uuid())
  senderId    String
  receiverId  String
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Quan h·ªá t·ªõi User
  sender     User   @relation("FriendshipSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User   @relation("FriendshipReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
}

enum ShopStatus {
  ACTIVE
  PENDING
  BANNED
  REJECTED
  VACATION // Ch·∫ø ƒë·ªô ngh·ªâ l·ªÖ
}

model User {
  id         String  @id @default(uuid())
  email         String?   @unique // ƒê·ªïi th√†nh Optional (c√≥ th·ªÉ null n·∫øu d√πng username)
  password   String? // D√†nh cho local auth
  username      String?   @unique // Th√™m tr∆∞·ªùng Username
  isVerified Boolean @default(false)
  name       String?
  phone      String?
  avatar     String?
  role       Role    @default(BUYER)
  sentFriendships     Friendship[] @relation("FriendshipSender")
  receivedFriendships Friendship[] @relation("FriendshipReceiver")
  isBanned    Boolean   @default(false) 
  banReason   String?   // L√Ω do b·ªã kh√≥a
  walletBalance Decimal @default(0) @db.Decimal(15, 2)
  payoutRequests    PayoutRequest[]
  walletTransactions WalletTransaction[]
  blogPosts BlogPost[]
  shopId         String?
  shop           Shop?        
  reviews     ProductReview[]
  shopReviews ShopReview[]
  createdVouchers Voucher[]     @relation("SellerVouchers") // Voucher do Seller n√†y t·∫°o
  savedVouchers   UserVoucher[]

  points      Int     @default(0) // S·ªë d∆∞ hi·ªán t·∫°i (snapshot ƒë·ªÉ query nhanh)
  pointTransactions PointTransaction[] // Quan h·ªá 1-n
  lastCheckIn    DateTime? // Th·ªùi gian l·∫ßn cu·ªëi ƒëi·ªÉm danh
  checkInStreak  Int       @default(0) // Chu·ªói ng√†y ƒëi·ªÉm danh li√™n ti·∫øp
  pointWallet PointWallet?
  pointHistory PointHistory[]
  dailyCheckIn DailyCheckIn?

  // Quan h·ªá
  cart      Cart?
  orders    Order[]
  products  Product[] // S·∫£n ph·∫©m do seller ƒëƒÉng b√°n
  addresses Address[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversations Conversation[] @relation("UserConversations")
  messages      Message[]

  shopName      String? @unique // T√™n shop (c·∫ßn Unique ƒë·ªÉ kh√¥ng tr√πng)
  pickupAddress String? // ƒê·ªãa ch·ªâ l·∫•y h√†ng
  description   String? // M√¥ t·∫£ shop
  coverImage    String? // ·∫¢nh b√¨a shop
  
  
  @@index([email])
  @@index([role])
  @@index([createdAt])
  
}
model ProductReview {
  id        String   @id @default(uuid())
  content   String?  @db.Text
  rating    Int      @default(5) // 1-5 sao
  images    Json?    // M·∫£ng URL ·∫£nh ƒë√°nh gi√°
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([productId])
  @@index([rating])
}

model ShopReview {
  id        String   @id @default(uuid())
  content   String?  @db.Text
  rating    Int      @default(5)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id])
  
  orderId   String   @unique // <--- QUAN TR·ªåNG: Th√™m @unique ƒë·ªÉ s·ª≠a l·ªói
  order     Order    @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId])
}
model Shop {
  id            String     @id @default(uuid())
  name          String     // T√™n hi·ªÉn th·ªã c·ªßa Shop
  slug          String     @unique // ƒê∆∞·ªùng d·∫´n ƒë·ªãnh danh (vd: shopee.vn/ten-shop)
  description   String?    @db.Text
  avatar        String?    // Logo Shop
  coverImage    String?    // ·∫¢nh b√¨a Shop
  pickupAddress String?    // ƒê·ªãa ch·ªâ kho l·∫•y h√†ng
  provinceId    Int?
  districtId    Int?
  wardCode      String?
  lat           Float?    @default(0)
  lng           Float?    @default(0)
  categoryId    String?      // ID Ng√†nh h√†ng ch·ªß l·ª±c (ƒë·ªÉ Optional v√¨ shop c≈© c√≥ th·ªÉ ch∆∞a c√≥)
  category      Category?    @relation("ShopMainCategory", fields: [categoryId], references: [id])
  status        ShopStatus @default(PENDING)
  orders      Order[]
  banReason     String?
  reviews ShopReview[]
  reviewCount Int @default(0)

  // --- C·∫•u h√¨nh giao di·ªán (Shop Decoration) ---
  // L∆∞u JSON c·∫•u tr√∫c trang tr√≠ (Banner slider, Featured Products, Video...)
  decoration    Json?      @default("{}") 
  shopCategories ShopCategory[]
  pendingDetails Json?
  
  // --- ƒê√°nh gi√° ---
  rating        Float      @default(0)
  totalSales    Int        @default(0) // T·ªïng s·∫£n ph·∫©m ƒë√£ b√°n

  // Quan h·ªá Owner
  ownerId       String     @unique // Hi·ªán t·∫°i 1 User - 1 Shop
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  address      String?    // N∆°i l∆∞u pickupAddress
  licenseImage String?    // N∆°i l∆∞u ·∫£nh gi·∫•y ph√©p
  taxCode       String?    // M√£ s·ªë thu·∫ø

  businessLicenseFront String? // ƒêKKD m·∫∑t tr∆∞·ªõc
  businessLicenseBack  String? // ƒêKKD m·∫∑t sau
  salesLicense         String? // Gi·∫•y ph√©p b√°n h√†ng
  trademarkCert        String? // ƒêƒÉng k√Ω nh√£n hi·ªáu
  distributorCert      String? // Ch·ª©ng nh·∫≠n ƒë·∫°i l√Ω/ph√¢n ph·ªëi

  // Quan h·ªá t√†i nguy√™n
  products      Product[]
  vouchers      Voucher[]  @relation("ShopVouchers")

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([name])
  @@index([status])
  @@index([categoryId])
}

// V√≠ ƒëi·ªÉm (T√°ch ri√™ng ƒë·ªÉ d·ªÖ lock row khi giao d·ªãch)
model PointWallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Int      @default(0) // S·ªë d∆∞ hi·ªán t·∫°i
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id])
}

// L·ªãch s·ª≠ bi·∫øn ƒë·ªông (Ledger)
model PointHistory {
  id          String   @id @default(uuid())
  userId      String
  amount      Int      // S·ªë d∆∞∆°ng l√† nh·∫≠n, √¢m l√† ti√™u
  type        String   // EARN, SPEND
  source      String   // CHECKIN, GACHA, ORDER, ADMIN_ADJUST
  description String?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
}

// Tr·∫°ng th√°i ƒëi·ªÉm danh
model DailyCheckIn {
  id              String   @id @default(uuid())
  userId          String   @unique
  lastCheckInDate DateTime // Ng√†y ƒëi·ªÉm danh g·∫ßn nh·∫•t
  currentStreak   Int      @default(0) // Chu·ªói hi·ªán t·∫°i
  
  user            User     @relation(fields: [userId], references: [id])
}

enum PointType {
  EARN_ORDER
  EARN_DAILY      // <--- ƒê√£ c√≥ (D√πng cho ƒëi·ªÉm danh)
  EARN_GAME
  EARN_AFFILIATE
  SPEND_ORDER
  SPEND_GAME
  REFUND
  EARN_TASK       // Nh·∫≠n t·ª´ l√†m nhi·ªám v·ª•
  TRANSFER_SENT   // Chuy·ªÉn xu ƒëi
  TRANSFER_RECEIVED // Nh·∫≠n xu t·ª´ ng∆∞·ªùi kh√°c
}

model PointTransaction {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  amount        Int       // S·ªë d∆∞∆°ng (+) ho·∫∑c √¢m (-)
  type          PointType
  balanceAfter  Int       // S·ªë d∆∞ sau khi th·ª±c hi·ªán (Snapshot)
  referenceId   String?   // ID tham chi·∫øu (v√≠ d·ª•: ng√†y ƒëi·ªÉm danh "DAILY_2024-01-01")
  description   String?
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([referenceId])
}

model Conversation {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now()) // ƒê·ªÉ s·∫Øp x·∫øp h·ªôi tho·∫°i

  // Quan h·ªá
  participants User[]    @relation("UserConversations") // Many-to-Many v·ªõi User
  messages     Message[]
}

// 3. Th√™m model Message (Tin nh·∫Øn)
model Message {
  id        String      @id @default(uuid())
  content   String // N·ªôi dung tin nh·∫Øn ho·∫∑c JSON string n·∫øu l√† product
  type      MessageType @default(TEXT)
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())

  // Quan h·ªá
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)
}

enum MessageType {
  TEXT
  IMAGE
  PRODUCT
}

model Address {
  id         String  @id @default(uuid())
  userId     String
  user       User    @relation(fields: [userId], references: [id])
  
  name       String? // T√™n ng∆∞·ªùi nh·∫≠n
  phone      String? // SƒêT ng∆∞·ªùi nh·∫≠n
  
  // ƒê·ªãa ch·ªâ chi ti·∫øt
  specificAddress String? // S·ªë nh√†, t√™n ƒë∆∞·ªùng (VD: 123 Nguy·ªÖn Tr√£i)
  fullAddress     String? // ƒê·ªãa ch·ªâ hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß (VD: 123 Nguy·ªÖn Tr√£i, Thanh Xu√¢n, H√† N·ªôi)

  // Th√¥ng tin ƒë·ªãnh danh GHN/Shipping
  provinceId Int?
  districtId Int?
  wardCode   String?
  
  isDefault  Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- CORE: DANH M·ª§C & S·∫¢N PH·∫®M ---

model Category {
  id    String  @id @default(uuid())
  name  String
  slug  String  @unique
  image String? // ·∫¢nh thumbnail c·ªßa danh m·ª•c
  shops       Shop[]    @relation("ShopMainCategory")
  // Quan h·ªá ƒë·ªá quy (Danh m·ª•c cha - con)
  // V√≠ d·ª•: Th·ªùi trang (Parent) -> √Åo (Child) -> √Åo ph√¥ng (Child)
  parentId String?
  parent   Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children Category[] @relation("CategoryParent")
  vouchers Voucher[]
  // S·∫£n ph·∫©m thu·ªôc danh m·ª•c n√†y
  products Product[]
  order     Int      @default(0)
  homeSections HomeSection[]

  // C·∫•u h√¨nh b·ªô l·ªçc cho danh m·ª•c n√†y
  // L∆∞u JSON m·∫£ng c√°c key filter. VD: ["size", "material", "style"] cho qu·∫ßn √°o
  // ho·∫∑c ["watts", "light_color"] cho ƒë·ªì ƒëi·ªán
  filterKeys Json? @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId]) 
  @@index([name])     
}

model ShopCategory {
  id        String   @id @default(uuid())
  name      String
  isActive  Boolean  @default(true)
  shopId    String
  shop      Shop?     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  products  Product[] // M·ªôt danh m·ª•c shop c√≥ nhi·ªÅu s·∫£n ph·∫©m
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopId])
}

enum SectionType {
  HERO_BANNER // Carousel to
  FLASH_SALE // Kh·ªëi Flash Sale
  CATEGORY_TWO_ROW // Kh·ªëi 2 c·ªôt (B√°n ch·∫°y / SP m·ªõi)
  SMART_PRODUCT // Kh·ªëi Smart Product (S·∫Øc ƒë·∫πp, ƒêi·ªán t·ª≠...)
  RECOMMENDED // Kh·ªëi g·ª£i √Ω cu·ªëi trang
  BANNER_SINGLE // Banner qu·∫£ng c√°o ƒë∆°n (n·∫øu c·∫ßn)
}

model HomePageSection {
  id       String      @id @default(uuid())
  title    String // T√™n n·ªôi b·ªô ƒë·ªÉ Admin qu·∫£n l√Ω (vd: "Kh·ªëi S·∫Øc ƒê·∫πp")
  type     SectionType // Lo·∫°i hi·ªÉn th·ªã
  isActive Boolean     @default(true)
  order    Int         @default(0) // S·ªë th·ª© t·ª± hi·ªÉn th·ªã (1, 2, 3...)

  // C·∫•u h√¨nh JSON ƒë·ªông. Admin s·∫Ω ch·ªânh JSON n√†y.
  // V√≠ d·ª• Smart Product: { "title": "S·∫ÆC ƒê·∫∏P", "emoji": "üíÑ", "query": "S·∫ÆC ƒê·∫∏P", "headerColor": "text-rose-500" }
  config Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ProductStatus {
  DRAFT // B·∫£n nh√°p (Seller ch∆∞a g·ª≠i duy·ªát)
  PENDING // Ch·ªù duy·ªát (M·∫∑c ƒë·ªãnh khi Seller t·∫°o xong)
  ACTIVE // ƒê√£ duy·ªát (Hi·ªán l√™n s√†n)
  REJECTED // T·ª´ ch·ªëi (K√®m l√Ω do)
  HIDDEN // Seller t·ª± ·∫©n
}


model Product {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String? @db.Text

  // Gi√° v√† T·ªìn kho
  price         Decimal  @db.Decimal(15, 2)
  originalPrice Decimal? @db.Decimal(15, 2) // Gi√° g·ªëc (ƒë·ªÉ hi·ªán g·∫°ch ngang gi·∫£m gi√°)
  stock         Int      @default(0)

  reviews ProductReview[]
  reviewCount Int @default(0)
  systemTags  Json @default("[]")
  // H√¨nh ·∫£nh (L∆∞u m·∫£ng JSON URL ·∫£nh)
  images Json
  status ProductStatus @default(PENDING) // M·∫∑c ƒë·ªãnh t·∫°o xong l√† ch·ªù duy·ªát ngay
  blogPosts BlogPost[]
  // (Optional) L√Ω do t·ª´ ch·ªëi n·∫øu Admin reject
  rejectReason String? @db.Text
  // --- T√çNH NƒÇNG DYNAMIC FILTER (QUAN TR·ªåNG) ---
  // L∆∞u c√°c thu·ªôc t√≠nh ƒë·ªông. 
  attributes   Json?
  tags String? @db.Text
  brandId     Int?
  brandRel    Brand?   @relation(fields: [brandId], references: [id])

  vouchers Voucher[]

  flashSaleItems FlashSaleProduct[]

  crossSells  ProductCrossSell[] @relation("MainProduct")
  crossSoldIn ProductCrossSell[] @relation("RelatedProduct")

  shopCategoryId  String?
  shopCategory    ShopCategory? @relation(fields: [shopCategoryId], references: [id])

  // 1 Product c√≥ nhi·ªÅu nh√≥m ph√¢n lo·∫°i (VD: Nh√≥m "M√†u s·∫Øc", Nh√≥m "Size")
  options ProductOption[]

  // 1 Product c√≥ nhi·ªÅu bi·∫øn th·ªÉ SKU (VD: "Xanh - S", "ƒê·ªè - M")
  variants ProductVariant[]

  // Th·ªëng k√™ (D√πng ƒë·ªÉ sort ph·ªï bi·∫øn, b√°n ch·∫°y)
  salesCount Int   @default(0)
  rating     Float @default(0)

  shopId        String?
  shop   Shop?   @relation(fields: [shopId], references: [id], onDelete: Cascade)
  weight Int @default(200)
  // Quan h·ªá
  sellerId String?
  seller   User?   @relation(fields: [sellerId], references: [id])

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Index ƒë·ªÉ t·ªëi ∆∞u t√¨m ki·∫øm v√† l·ªçc
  @@index([name])
  @@index([categoryId, createdAt(sort: Desc)])
  @@index([categoryId, price])
  @@index([name, createdAt(sort: Desc)])
  @@index([sellerId, createdAt(sort: Desc)])
  @@index([slug])
  @@index([shopId])
}

model Brand {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  logoUrl     String?
  description String?  @db.Text
  status      String   @default("active") // 'active' | 'inactive'
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    Product[] // Relation to products
}

model ProductCrossSell {
  productId        String
  relatedProductId String

  product        Product @relation("MainProduct", fields: [productId], references: [id], onDelete: Cascade)
  relatedProduct Product @relation("RelatedProduct", fields: [relatedProductId], references: [id], onDelete: Cascade)

  @@id([productId, relatedProductId])
  @@index([productId])
}

model ProductOption {
  id        String @id @default(uuid())
  productId String
  name      String // VD: "M√†u s·∫Øc"
  position  Int // Th·ª© t·ª± hi·ªÉn th·ªã (0, 1)

  values  ProductOptionValue[]
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductOptionValue {
  id       String        @id @default(uuid())
  optionId String
  value    String // VD: "Xanh", "ƒê·ªè"
  image    String?
  position Int           @default(0)
  option   ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@index([optionId])
}

model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  price     Decimal
  stock     Int
  sku       String? // M√£ SKU ri√™ng cho bi·∫øn th·ªÉ
  image     String? // ·∫¢nh ri√™ng cho bi·∫øn th·ªÉ (VD: ·∫¢nh √°o m√†u ƒë·ªè)
  flashSaleItems FlashSaleProduct[]
  // L∆∞u index k·∫øt h·ª£p d∆∞·ªõi d·∫°ng JSON ho·∫∑c String ƒë·ªÉ map nhanh
  // VD: [0, 1] nghƒ©a l√† Option 1 (index 0) + Option 2 (index 1)
  tierIndex String // Format: "0,0", "0,1" (Map v·ªõi array values c·ªßa FE g·ª≠i l√™n)

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// --- SHOPPING CART ---

model Cart {
  id     String     @id @default(uuid())
  userId String     @unique
  user   User       @relation(fields: [userId], references: [id])
  items  CartItem[]

  updatedAt DateTime @updatedAt
}

model CartItem {
  id        String  @id @default(uuid())
  cartId    String
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int

  // L∆∞u t√πy ch·ªçn s·∫£n ph·∫©m trong gi·ªè (n·∫øu c√≥ variant)
  // V√≠ d·ª•: { "color": "Red", "size": "M" }
  selectedOptions Json?

  @@unique([cartId, productId])
}

model AnalyticsLog {
  id        String   @id @default(uuid())
  userId    String? // Null n·∫øu l√† Guest
  guestId   String? // Device ID
  eventType String // view, click, add_to_cart, purchase...
  targetId  String? // ProductID
  metadata  Json? // Ch·ª©a gi√°, ngu·ªìn traffic, t·ª´ kh√≥a search...
  createdAt DateTime @default(now())

  // T·ªêI ∆ØU INDEX CHO BIG DATA QUERY
  @@index([userId])
  @@index([guestId])
  @@index([eventType, createdAt]) // Query theo lo·∫°i event trong kho·∫£ng th·ªùi gian
  @@index([targetId]) // ƒê·ªÉ ƒë·∫øm view/sale c·ªßa s·∫£n ph·∫©m
}

// --- ORDER SYSTEM ---
model Order {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  status      OrderStatus @default(PENDING) // PENDING, PAID, SHIPPED, CANCELLED
  totalAmount Decimal
  shippingFee Decimal     @default(0)

  voucherId String? // C√≥ th·ªÉ null n·∫øu kh√¥ng d√πng voucher
  voucher   Voucher? @relation(fields: [voucherId], references: [id], onDelete: SetNull)
  shippingOrderCode String? // M√£ ƒë∆°n GHN (v√≠ d·ª•: L8CC23)
  shippingProvider  String? @default("GHN")
  productReviews ProductReview[]
  shopReview     ShopReview?
  isReviewed     Boolean @default(false)
  shopId        String?      
  shop          Shop?   @relation(fields: [shopId], references: [id])

  districtId        Int?    // ID Qu·∫≠n/Huy·ªán (GHN)
  wardCode          String? // M√£ Ph∆∞·ªùng/X√£ (GHN)
  provinceId        Int?    // ID T·ªânh/Th√†nh

  // Th√¥ng tin ng∆∞·ªùi nh·∫≠n (cho Gift)
  recipientName    String?
  recipientPhone   String?
  recipientAddress String?
  message          String? // L·ªùi ch√∫c
  isGift           Boolean @default(false)

  paymentMethod String // MOMO, BANKING, COD
  paymentStatus String @default("UNPAID")

  items     OrderItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String?  // 1. ƒê·ªïi th√†nh Optional (Th√™m d·∫•u ?)
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  quantity Int
  price    Decimal // L∆∞u gi√° t·∫°i th·ªùi ƒëi·ªÉm mua (ƒë·ªÅ ph√≤ng gi√° g·ªëc ƒë·ªïi)
}

// Th√™m v√†o schema.prisma

enum VoucherType {
  FIXED_AMOUNT // Gi·∫£m s·ªë ti·ªÅn c·ªë ƒë·ªãnh (v√≠ d·ª•: 50k)
  PERCENTAGE // Gi·∫£m theo % (v√≠ d·ª•: 10%)
}

enum VoucherScope {
  GLOBAL // Voucher s√†n
  SHOP // Voucher c·ªßa Shop
  PRODUCT // Voucher cho s·∫£n ph·∫©m c·ª• th·ªÉ
  CATEGORY
}

enum DiscountStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  DEPLETED // H·∫øt l∆∞·ª£t d√πng
}

model Voucher {
  id          String       @id @default(uuid())
  code        String       @unique
  name        String
  description String?
  type        VoucherType
  scope       VoucherScope

  amount        Decimal  @db.Decimal(10, 2)
  maxDiscount   Decimal? @db.Decimal(10, 2)
  minOrderValue Decimal  @default(0) @db.Decimal(10, 2)

  usageLimit     Int
  usageCount     Int @default(0)
  userUsageLimit Int @default(1)

  homeSections HomeSection[]

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)

  shopId         String?
  shop           Shop?        @relation("ShopVouchers", fields: [shopId], references: [id], onDelete: Cascade)

  // Relation v·ªõi User (Seller t·∫°o voucher)
  sellerId String?
  seller   User?   @relation("SellerVouchers", fields: [sellerId], references: [id])

  // Relation v·ªõi Product (Voucher √°p d·ª•ng cho SP n√†o)
  products Product[]

  // Relation v·ªõi Order (Voucher n√†y ƒë√£ d√πng cho ƒë∆°n n√†o)
  orders Order[]
  categories Category[]

  // Tracking (Ai ƒë√£ l∆∞u voucher)
  userVouchers UserVoucher[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(0)

  @@index([shopId])
  @@index([startDate, endDate])
}

model UserVoucher {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade) // ƒê√£ kh·ªõp v·ªõi savedVouchers b√™n User

  voucherId String
  voucher   Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)

  isUsed Boolean   @default(false)
  usedAt DateTime?

  createdAt DateTime @default(now())

  @@unique([userId, voucherId])
}

model HomeSection {
  id          String   @id @default(uuid())
  title       String   
  type        String   // "CATEGORY", "FLASH_SALE", "BANNER"
  order       Int      @default(0)
  isActive    Boolean  @default(true)

  // C·∫•u h√¨nh hi·ªÉn th·ªã (JSON)
  config      Json?

  // Quan h·ªá
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])

  voucherId   String?
  voucher     Voucher?  @relation(fields: [voucherId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
}

model Banner {
  id          String   @id @default(uuid())
  location    String   // 'HERO_MAIN', 'HERO_SUB', 'SIDEBAR_PROMO'
  src         String   // URL ·∫£nh
  alt         String?
  title       String?
  description String?
  ctaLabel    String?  // N√∫t k√™u g·ªçi h√†nh ƒë·ªông
  ctaLink     String?  // Link ƒë√≠ch
  theme       String?  // 'dark' | 'light'
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Qu·∫£n l√Ω c√°c c·∫•u h√¨nh menu ph·ª©c t·∫°p (Header Menu, Footer Link...)
model SystemConfig {
  key         String   @id // VD: 'HEADER_MEGA_MENU', 'HEADER_RECIPIENT_DATA', 'FOOTER_DATA'
  value       Json     // L∆∞u c·∫•u tr√∫c m·∫£ng/object ph·ª©c t·∫°p
  description String?
  updatedAt   DateTime @updatedAt
}

model PayoutRequest {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  amount      Decimal      @db.Decimal(15, 2)
  status      PayoutStatus @default(PENDING)
  bankInfo    String       // Format: "BankName - AccountNum - OwnerName"
  reason      String?      // L√Ω do t·ª´ ch·ªëi (n·∫øu c√≥)
  processedAt DateTime?    // Ng√†y admin duy·ªát/t·ª´ ch·ªëi
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([userId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
}

model WalletTransaction {
  id          String                  @id @default(uuid())
  userId      String
  user        User                    @relation(fields: [userId], references: [id])
  amount      Decimal                 @db.Decimal(15, 2) // S·ªë d∆∞∆°ng (+) l√† thu nh·∫≠p, S·ªë √¢m (-) l√† r√∫t ti·ªÅn
  type        WalletTransactionType
  status      WalletTransactionStatus @default(COMPLETED)
  referenceId String?                 // Order ID ho·∫∑c PayoutRequest ID
  description String?
  createdAt   DateTime                @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

enum WalletTransactionType {
  ORDER_INCOME   // Ti·ªÅn b√°n h√†ng c·ªông v√†o
  PAYOUT         // R√∫t ti·ªÅn v·ªÅ ng√¢n h√†ng
  REFUND         // Ho√†n ti·ªÅn cho kh√°ch
  FEE            // Ph√≠ s√†n (n·∫øu c√≥)
}

enum WalletTransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum FlashSaleStatus {
  ENABLED
  DISABLED
}

enum FlashSaleProductStatus {
  PENDING
  APPROVED
  REJECTED
}

model FlashSaleSession {
  id          String   @id @default(uuid())
  startTime   DateTime
  endTime     DateTime
  status      FlashSaleStatus @default(ENABLED)
  
  // Quan h·ªá 1-n
  products    FlashSaleProduct[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Index gi√∫p query session theo th·ªùi gian nhanh h∆°n
  @@index([startTime, endTime])
}

model FlashSaleProduct {
  id               String @id @default(uuid())
  
  // Quan h·ªá t·ªõi Session
  sessionId        String
  session          FlashSaleSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Quan h·ªá t·ªõi Product
  productId        String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  
  variantId       String
  variant         ProductVariant   @relation(fields: [variantId], references: [id])

  originalPrice    Decimal @db.Decimal(15, 2)
  salePrice        Decimal @db.Decimal(15, 2)
  stock            Int     // S·ªë l∆∞·ª£ng cam k·∫øt ch·∫°y Flash Sale
  sold             Int     @default(0) // S·ªë l∆∞·ª£ng ƒë√£ b√°n
  status           FlashSaleProductStatus @default(PENDING)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([sessionId])
  @@index([productId])
  @@unique([sessionId, variantId])
}

model BlogCategory {
  id        String         @id @default(uuid())
  name      String
  slug      String         @unique
  parentId  String?
  parent    BlogCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  BlogCategory[] @relation("CategoryHierarchy")
  posts     BlogPost[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model BlogPost {
  id              String   @id @default(uuid())
  title           String
  slug            String   @unique
  excerpt         String?  @db.Text
  content         String   @db.Text
  thumbnail       String?
  status          String   @default("DRAFT")
  categoryId      String?
  category        BlogCategory? @relation(fields: [categoryId], references: [id])

  // --- SEO Fields ---
  metaTitle       String?
  metaDescription String?
  
  // FIX 1: Change String[] to String? for MySQL
  keywords        String?  @db.Text 
  
  canonicalUrl    String?
  ogImage         String?
  noIndex         Boolean  @default(false)

  // --- Relations ---
  authorId        String
  author          User     @relation(fields: [authorId], references: [id])
  relatedProducts Product[]
  sortOrder   Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  @@index([sortOrder])
}

